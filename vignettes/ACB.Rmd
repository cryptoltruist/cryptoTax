---
title: "Adjusted Cost Base"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adjusted Cost Base}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette, we will demonstrate that calculations of the adjusted cost base by `cryptoTax` closely follows those of https://www.adjustedcostbase.ca/.

# Basic ACB

To begin, we will replicate the basic ACB example showcased in https://www.adjustedcostbase.ca/blog/how-to-calculate-adjusted-cost-base-acb-and-capital-gains/

![](images/ACB0.png)

We first generate the data:

```{r}
library(cryptoTax)
data <- adjustedcostbase.ca_1
data
```

Next, we generate the calculations to achieve the following result:

![](images/ACB1.png)

```{r}
ACB(data, spot.rate = "price", sup.loss = FALSE)
```

# Superficial losses

We will now replicate the more advanced superficial loss example showcased at https://www.adjustedcostbase.ca/blog/what-is-the-superficial-loss-rule/.

## Example 1

We first demonstrate the "Violation of the Superficial Loss Rule" by using regular ACB *without* accounting for superficial losses:

![](images/ACB2.png)

```{r}
data <- adjustedcostbase.ca_2
x <- ACB(data, spot.rate = "price", sup.loss = FALSE)
```

Per default, there are a lot of columns to provide as much information as possible. To make it look as short as the adjustedcostbase.ca example, we can subselect relevant columns:

```{r, message=F}
library(dplyr)
select(x, date, transaction, quantity, price, total.quantity, ACB, ACB.share, gains)
```

Next, we do it the correct way, *accounting* for superficial losses:

![](images/ACB3.png)

```{r}
x <- ACB(x, spot.rate = "price")
select(x, date, transaction, quantity, price, total.quantity, ACB, ACB.share, gains)
```

## Example 2

We continue with the second superficial loss example. We first demonstrate the "Violation of the Superficial Loss Rule" by using regular ACB *without* accounting for superficial losses:

![](images/ACB4.png)

```{r}
data <- adjustedcostbase.ca_3
x <- ACB(data, spot.rate = "price", sup.loss = FALSE)
select(x, date, transaction, quantity, price, total.quantity, ACB, ACB.share, gains)
```

Next, we do it the correct way, *accounting* for superficial losses:

![](images/ACB5.png)

```{r}
x <- ACB(data, spot.rate = "price")
select(x, date, transaction, quantity, price, total.quantity, ACB, ACB.share, gains)
```

## Example 3

We continue with the third superficial loss example (first example in https://www.adjustedcostbase.ca/blog/applying-the-superficial-loss-rule-for-a-partial-disposition-of-shares/). We first demonstrate the "Violation of the Superficial Loss Rule" by using regular ACB *without* accounting for superficial losses:

### When Shares are Sold at a Loss and then Partially Reacquired within the Superficial Loss Period

![](images/ACB6.png)

```{r}
data <- adjustedcostbase.ca_4
x <- ACB(data, spot.rate = "price", sup.loss = FALSE)
select(x, date, transaction, quantity, price, total.price, total.quantity, ACB, ACB.share, gains)
```

Next, we do it the correct way, *accounting* for superficial losses:

![](images/ACB7.png)

```{r}
x <- ACB(data, spot.rate = "price")
select(x, date, transaction, quantity, price, total.quantity, ACB, ACB.share, gains)
```

## Example 4

We continue with the fourth superficial loss example (second example in https://www.adjustedcostbase.ca/blog/applying-the-superficial-loss-rule-for-a-partial-disposition-of-shares/). We first demonstrate the "Violation of the Superficial Loss Rule" by using regular ACB *without* accounting for superficial losses:

### When Shares are Purchased and then Partially Sold within the Superficial Loss Period

![](images/ACB8.png)

```{r}
data <- adjustedcostbase.ca_5
x <- ACB(data, spot.rate = "price", sup.loss = FALSE)
select(x, date, transaction, quantity, price, total.price, total.quantity, ACB, ACB.share, gains)
```

Next, we do it the correct way, *accounting* for superficial losses:

![](images/ACB9.png)

```{r}
x <- ACB(data, spot.rate = "price")
select(x, date, transaction, quantity, price, total.quantity, ACB, ACB.share, gains)
```

## Example 5

### When Multiple Acquisitions and/or Multiple Dispositions Occur Within the Superficial Loss Period

There are no examples given for this one, so we make our own. adjustedcostbase.ca writes that the web-based application does not support claiming partial losses automatically:

> Note that AdjustedCostBase.ca does not automatically apply the superficial loss rule for you.  Although you’ll see superficial loss rule warnings being displayed in many cases, it’s up to you to edit the transaction to apply the superficial loss rule.  Also, in cases where you’re partially claiming a loss due to the superficial loss rule, you’ll need to manually calculate the partial capital loss using the methods described above.

Fortunately, `cryptoTax` allows claiming partial losses automatically. We first demonstrate the "Violation of the Superficial Loss Rule" by using regular ACB *without* accounting for superficial losses:

```{r}
data <- adjustedcostbase.ca_6
x <- ACB(data, spot.rate = "price", sup.loss = FALSE)
select(x, date, transaction, quantity, price, total.price, total.quantity, ACB, ACB.share, gains)
```

Next, we do it the correct way, *accounting* for superficial losses, and include a few more columns for the demonstration:

```{r}
x <- ACB(data, spot.rate = "price")
select(
  x, date, transaction, quantity, price, total.quantity,
  suploss.range, sup.loss, sup.loss.quantity, ACB, ACB.share,
  gains.uncorrected, gains.sup, gains.excess, gains
)
```
